<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>File Share Test</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
</head>
<body>
  <h2>File Upload Test</h2>
  <input type="file" id="fileInput">
  <button id="uploadBtn">Upload & Generate Code</button>
  <p id="status"></p>

  <script>
    const SUPABASE_URL = "https://vlmykouutjxilcykavpj.supabase.co"; // your project
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZsbXlrb3V1dGp4aWxjeWthdnBqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzODI4OTIsImV4cCI6MjA3MTk1ODg5Mn0.9Fi4Vo3Tqho4GkvUZASEGknmTDteghxm8Hdvsr6RW0w";
    const BUCKET = "secondbucket"; // must exist in Supabase
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    document.getElementById("uploadBtn").addEventListener("click", async () => {
      const file = document.getElementById("fileInput").files[0];
      if (!file) {
        document.getElementById("status").textContent = "⚠️ Please choose a file first!";
        return;
      }

      // Generate 3-digit random code
      const code = Math.floor(100 + Math.random() * 900).toString();

      // Upload to Supabase Storage
      const { error: uploadError } = await supabaseClient.storage
        .from(BUCKET)
        .upload(`${code}/${file.name}`, file, { upsert: true });

      if (uploadError) {
        document.getElementById("status").textContent = "❌ Upload failed: " + uploadError.message;
        return;
      }

      // Insert into file_codes table
      const { error: insertError } = await supabaseClient
        .from("file_codes")
        .insert([{ code: code, path: `${code}/${file.name}` }]);

      if (insertError) {
        document.getElementById("status").textContent = "⚠️ Upload ok but DB insert failed: " + insertError.message;
        return;
      }

      // Show success + code
      document.getElementById("status").textContent = `✅ Uploaded! Your code is: ${code}`;
    });
  </script>
</body>
</html>

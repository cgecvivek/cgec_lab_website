<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SnapShare • 3-Digit File Access</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { font-family: 'Inter', sans-serif; background: linear-gradient(to bottom right, #eef2ff, #e0f7fa); }
  .glass { background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); }
</style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

<div class="max-w-lg w-full glass rounded-2xl shadow-xl p-6">
  <h1 class="text-2xl font-extrabold text-slate-800 mb-4 text-center">SnapShare</h1>

  <!-- Upload Section -->
  <h2 class="font-semibold mb-2">Upload File</h2>
  <input type="file" id="fileInput" class="block w-full mb-2 text-sm"/>
  <div id="fileMeta" class="text-xs text-slate-500 mb-2 hidden"></div>
  <button id="uploadBtn" class="w-full py-2 rounded-xl bg-cyan-600 text-white font-semibold hover:bg-cyan-700 shadow mb-4">Upload & Generate Code</button>
  <div id="uploadResult" class="hidden flex flex-col items-center gap-2">
    <span class="font-mono text-lg" id="codeDisplay">---</span>
    <button id="copyBtn" class="px-3 py-1.5 rounded-lg bg-indigo-600 text-white text-sm hover:bg-indigo-700">Copy Code</button>
  </div>

  <hr class="my-4"/>

  <!-- Retrieve Section -->
  <h2 class="font-semibold mb-2">Retrieve File</h2>
  <input type="text" id="codeInput" maxlength="3" placeholder="Enter 3-digit code" class="block w-full mb-2 p-2 rounded-xl border"/>
  <button id="retrieveBtn" class="w-full py-2 rounded-xl bg-indigo-600 text-white font-semibold hover:bg-indigo-700 shadow mb-2">Lookup</button>
  <div id="retrieveResult" class="hidden mt-2 flex flex-col items-center gap-2">
    <span id="fileName" class="font-medium"></span>
    <a id="accessBtn" href="#" target="_blank" class="px-4 py-2 rounded-xl bg-green-600 text-white font-semibold hover:bg-green-700 shadow">Access File</a>
  </div>

  <p id="statusMsg" class="mt-2 text-sm text-center text-slate-700"></p>
</div>

<script src="https://unpkg.com/@supabase/supabase-js"></script>
<script>
const SUPABASE_URL = "https://vlmykouutjxilcykavpj.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZsbXlrb3V1dGp4aWxjeWthdnBqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzODI4OTIsImV4cCI6MjA3MTk1ODg5Mn0.9Fi4Vo3Tqho4GkvUZASEGknmTDteghxm8Hdvsr6RW0w";
const BUCKET = "secondbucket";

const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Elements
const fileInput = document.getElementById('fileInput');
const fileMeta = document.getElementById('fileMeta');
const uploadBtn = document.getElementById('uploadBtn');
const uploadResult = document.getElementById('uploadResult');
const codeDisplay = document.getElementById('codeDisplay');
const copyBtn = document.getElementById('copyBtn');

const codeInput = document.getElementById('codeInput');
const retrieveBtn = document.getElementById('retrieveBtn');
const retrieveResult = document.getElementById('retrieveResult');
const fileNameEl = document.getElementById('fileName');
const accessBtn = document.getElementById('accessBtn');

const statusMsg = document.getElementById('statusMsg');

// Show file info on select
fileInput.addEventListener('change', ()=>{
  const f = fileInput.files[0];
  if(!f){ fileMeta.classList.add('hidden'); return; }
  fileMeta.classList.remove('hidden');
  fileMeta.textContent = `${f.name} • ${(f.size/1024/1024).toFixed(2)} MB • ${f.type || 'unknown type'}`;
});

// Generate 3-digit code
function randomCode(){ return Math.floor(100 + Math.random()*900).toString(); }

// Upload handler
uploadBtn.addEventListener('click', async ()=>{
  const f = fileInput.files[0];
  if(!f){ statusMsg.textContent = "⚠️ Select a file"; return; }

  statusMsg.textContent = "Uploading...";
  uploadBtn.disabled = true;

  const code = randomCode();
  const path = `${code}/${f.name}`;

  // Upload file
  const { error: uploadError } = await supabase.storage.from(BUCKET).upload(path, f, { upsert:true });
  if(uploadError){ statusMsg.textContent = "❌ Upload failed: " + uploadError.message; uploadBtn.disabled=false; return; }

  // Insert into table
  const { error: insertError } = await supabase.from('file_codes').insert([{ code, path }]);
  if(insertError){ statusMsg.textContent = "⚠️ Upload ok but DB insert failed: "+insertError.message; uploadBtn.disabled=false; return; }

  // Show code + access button
  codeDisplay.textContent = code;
  const { data: publicUrl } = supabase.storage.from(BUCKET).getPublicUrl(path);
  accessBtn.href = publicUrl.publicUrl;

  uploadResult.classList.remove('hidden');
  statusMsg.textContent = "✅ Uploaded successfully!";
  uploadBtn.disabled = false;
});

// Copy code
copyBtn.addEventListener('click', async ()=>{
  await navigator.clipboard.writeText(codeDisplay.textContent);
  copyBtn.textContent = "Copied!";
  setTimeout(()=>copyBtn.textContent="Copy Code", 1200);
});

// Retrieve file
retrieveBtn.addEventListener('click', async ()=>{
  const code = codeInput.value.trim();
  if(!/^[0-9]{3}$/.test(code)){ statusMsg.textContent="Enter valid 3-digit code"; return; }

  statusMsg.textContent = "Looking up...";
  retrieveResult.classList.add('hidden');

  const { data, error } = await supabase.from('file_codes').select('*').eq('code', code).single();
  if(error || !data){ statusMsg.textContent = "No file found for this code"; return; }

  const { data: publicUrl } = supabase.storage.from(BUCKET).getPublicUrl(data.path);
  fileNameEl.textContent = data.path.split('/')[1];
  accessBtn.href = publicUrl.publicUrl;
  retrieveResult.classList.remove('hidden');
  statusMsg.textContent = "File found!";
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>File Share via Code</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; display:flex; justify-content:center; align-items:center; height:100vh; }
    .card { background:white; padding:20px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.15); width:350px; text-align:center; }
    button { margin-top:15px; padding:10px 20px; border:none; border-radius:8px; background:#007bff; color:white; font-size:16px; cursor:pointer; }
    button:hover { background:#0056b3; }
    input[type=file], input[type=text] { margin:10px 0; }
  </style>
</head>
<body>
  <div class="card">
    <h2>ðŸ“‚ File Share</h2>

    <input type="file" id="fileInput" />
    <br/>
    <button id="uploadBtn">Upload & Generate Code</button>

    <hr/>

    <input type="text" id="codeInput" placeholder="Enter 3-digit code" />
    <br/>
    <button id="fetchBtn">Fetch File</button>
  </div>

  <script>
    // Replace with YOUR Supabase project URL + anon key
    const SUPABASE_URL = "https://vlmykouutjxilcykavpj.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZsbXlrb3V1dGp4aWxjeWthdnBqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzODI4OTIsImV4cCI6MjA3MTk1ODg5Mn0.9Fi4Vo3Tqho4GkvUZASEGknmTDteghxm8Hdvsr6RW0w";
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    console.log("Supabase client:", supabase);

    const uploadBtn = document.getElementById("uploadBtn");
    const fetchBtn = document.getElementById("fetchBtn");
    const fileInput = document.getElementById("fileInput");
    const codeInput = document.getElementById("codeInput");

    // Upload handler
    uploadBtn.addEventListener("click", async () => {
      const f = fileInput.files?.[0];
      if (!f) {
        alert("Please select a file first.");
        return;
      }

      console.log("File selected:", f.name);

      const code = Math.floor(100 + Math.random() * 900).toString();
      const path = `${code}-${f.name}`;

      // Upload file
      const { data, error } = await supabase.storage.from("secondbucket").upload(path, f);

      if (error) {
        console.error("Upload failed:", error);
        alert("Upload failed: " + error.message);
        return;
      }
      console.log("Upload success:", data);

      // Save mapping in DB
      const { error: dbError } = await supabase.from("file_codes").insert([{ code, path }]);
      if (dbError) {
        console.error("DB insert failed:", dbError);
        alert("DB insert failed: " + dbError.message);
        return;
      }

      alert("âœ… File uploaded! Your code: " + code);
    });

    // Fetch handler
    fetchBtn.addEventListener("click", async () => {
      const code = codeInput.value.trim();
      if (!code) {
        alert("Enter a code first!");
        return;
      }

      const { data, error } = await supabase.from("file_codes").select("path").eq("code", code).single();

      if (error || !data) {
        alert("Code not found!");
        return;
      }

      const { data: urlData } = await supabase.storage.from("secondbucket").createSignedUrl(data.path, 60);
      if (!urlData?.signedUrl) {
        alert("Could not generate download link.");
        return;
      }

      window.open(urlData.signedUrl, "_blank");
    });
  </script>
</body>
</html>
